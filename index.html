<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Daylight Zombie Defense</title>
    <style>
        :root { --n: #2ecc71; --h: #e74c3c; --p: #9b59b6; }
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Segoe UI', sans-serif; touch-action: none; color: #333; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.9); z-index: 100; text-align: center; }
        .hidden { display: none !important; }
        
        #hud { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .stat { background: rgba(255,255,255,0.8); border-left: 4px solid var(--n); padding: 8px; margin-bottom: 5px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        #crosshair { position: absolute; inset: 50%; width: 20px; height: 20px; border: 2px solid #000; border-radius: 50%; transform: translate(-50%,-50%); pointer-events: none; z-index: 5; }
        .hit #crosshair { border-color: var(--h); transform: translate(-50%,-50%) scale(1.5); }
        
        #controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; z-index: 50; }
        .btn { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #333; display: flex; justify-content: center; align-items: center; font-weight: bold; background: white; }
        #fire-btn { border-color: var(--h); color: var(--h); }
        #ability-btn { border-color: var(--p); color: var(--p); font-size: 0.7rem; }

        button { padding: 15px 40px; background: #333; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="hud" class="hidden">
    <div class="stat">KILLS: <span id="s-val">0</span></div>
    <div class="stat" id="ability-status" style="color:var(--p)">ANIME POWER: READY</div>
</div>

<div id="crosshair" class="hidden"></div>

<div id="controls" class="hidden">
    <div id="ability-btn" class="btn">GEAR 5</div>
    <div id="fire-btn" class="btn">FIRE</div>
</div>

<div id="menu" class="screen">
    <h1>ZOMBIE SUBURBIA</h1>
    <p>The car is parked. Don't let them climb on!</p>
    <button id="start-btn">START SURVIVAL</button>
</div>

<div id="game-over" class="screen hidden">
    <h1 style="color:var(--h)">GAME OVER</h1>
    <p>The zombies broke the windows.</p>
    <button onclick="location.reload()">TRY AGAIN</button>
</div>

<script type="module">
import * as THREE from "https://cdn.skypack.dev/three@0.136.0";

const $ = id => document.getElementById(id);
let score = 0, run = false, abilityReady = true, pool = [], houses = [];
let lon = 0, lat = 0, abilityActive = false;

// --- Scene ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB); // Sky Blue
const cam = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// --- Lighting ---
const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
scene.add(hemi);
const sun = new THREE.DirectionalLight(0xffffff, 0.8);
sun.position.set(50, 100, 50);
scene.add(sun);

// --- Realistic Car Construction ---
const car = new THREE.Group();
const bodyMat = new THREE.MeshPhongMaterial({color: 0x333333});
const glassMat = new THREE.MeshPhongMaterial({color: 0x88ccff, transparent: true, opacity: 0.4});

const chassis = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.6, 5), bodyMat);
chassis.position.y = 0.5;
car.add(chassis);

const roof = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.5, 2.5), bodyMat);
roof.position.set(0, 1.2, 0.5);
car.add(roof);

// Pillars
const p1 = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.8, 0.1), bodyMat);
p1.position.set(1, 0.9, -0.5); car.add(p1);
const p2 = p1.clone(); p2.position.x = -1; car.add(p2);

// Bumper
const bumper = new THREE.Mesh(new THREE.BoxGeometry(2.6, 0.3, 0.2), new THREE.MeshPhongMaterial({color: 0x111111}));
bumper.position.set(0, 0.4, -2.5);
car.add(bumper);

scene.add(car);

// --- Neighborhood ---
const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshLambertMaterial({color: 0x7cfc00}));
ground.rotation.x = -Math.PI/2;
scene.add(ground);

const road = new THREE.Mesh(new THREE.PlaneGeometry(12, 100), new THREE.MeshLambertMaterial({color: 0x333333}));
road.rotation.x = -Math.PI/2;
road.position.y = 0.01;
scene.add(road);

function addHouse(x, z) {
    const h = new THREE.Group();
    const base = new THREE.Mesh(new THREE.BoxGeometry(5, 4, 5), new THREE.MeshPhongMaterial({color: Math.random() * 0xffffff}));
    const roof = new THREE.Mesh(new THREE.ConeGeometry(4, 3, 4), new THREE.MeshPhongMaterial({color: 0x8b4513}));
    roof.position.y = 3.5; roof.rotation.y = Math.PI/4;
    h.add(base, roof);
    h.position.set(x, 2, z);
    scene.add(h);
}

for(let i=0; i<6; i++) {
    addHouse(-12, -30 + (i*15));
    addHouse(12, -30 + (i*15));
}

// --- Zombies ---
const createZombie = () => {
    const g = new THREE.Group();
    const b = new THREE.Mesh(new THREE.CapsuleGeometry(0.3, 1), new THREE.MeshPhongMaterial({color: 0x556644}));
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshPhongMaterial({color: 0xdddddd}));
    head.position.y = 0.8;
    g.add(b, head);
    g.userData = { active: false };
    return g;
};

for(let i=0; i<25; i++) {
    const z = createZombie();
    z.visible = false;
    scene.add(z);
    pool.push(z);
}

const spawn = () => {
    if(!run) return;
    const z = pool.find(x => !x.userData.active);
    if(!z) return;
    const angle = Math.random() * Math.PI * 2;
    const dist = 20;
    z.position.set(Math.cos(angle)*dist, 0.8, Math.sin(angle)*dist);
    z.userData.active = true;
    z.visible = true;
};

// --- Input (Fixed Glitch) ---
let isDown = false, px, py;
window.addEventListener("touchstart", e => { isDown = true; px = e.touches[0].clientX; py = e.touches[0].clientY; });
window.addEventListener("touchend", () => { isDown = false; });
window.addEventListener("touchmove", e => {
    if(!run || !isDown) return;
    const dx = e.touches[0].clientX - px;
    const dy = e.touches[0].clientY - py;
    lon -= dx * 0.2;
    lat = Math.max(-30, Math.min(60, lat + dy * 0.2));
    px = e.touches[0].clientX;
    py = e.touches[0].clientY;
});

// --- Gameplay ---
$("fire-btn").ontouchstart = (e) => {
    e.preventDefault();
    if(!run) return;
    const ray = new THREE.Raycaster();
    ray.setFromCamera({x:0, y:0}, cam);
    const hits = ray.intersectObjects(pool, true);
    if(hits.length > 0) {
        let t = hits[0].object;
        while(t.parent && !t.userData.active) t = t.parent;
        if(t.userData.active) {
            t.userData.active = false;
            score++; $("s-val").textContent = score;
            $("crosshair").classList.add("hit");
            setTimeout(()=>$("crosshair").classList.remove("hit"), 100);
        }
    }
};

$("ability-btn").ontouchstart = () => {
    if(!abilityReady || !run) return;
    abilityReady = false; abilityActive = true;
    $("ability-status").textContent = "GEAR 5 ACTIVE!";
    // Luffy Ability: Blast away all zombies
    pool.forEach(z => {
        if(z.userData.active) {
            z.userData.active = false;
            score++;
        }
    });
    $("s-val").textContent = score;
    setTimeout(() => { 
        abilityActive = false;
        abilityReady = true;
        $("ability-status").textContent = "ANIME POWER: READY";
    }, 8000);
};

$("start-btn").onclick = () => {
    run = true;
    $("menu").classList.add("hidden");
    $("hud").classList.remove("hidden");
    $("crosshair").classList.remove("hidden");
    $("controls").classList.remove("hidden");
    setInterval(spawn, 1200);
};

// --- Main Loop ---
function loop() {
    requestAnimationFrame(loop);
    if(!run) return;

    // Smooth Camera
    const phi = THREE.MathUtils.degToRad(90 - lat);
    const theta = THREE.MathUtils.degToRad(lon);
    const target = new THREE.Vector3().setFromSphericalCoords(1, phi, theta);
    cam.lookAt(cam.position.clone().add(target));

    pool.forEach(z => {
        if(z.userData.active) {
            const dir = new THREE.Vector3(0, 0.8, 0).sub(z.position).normalize();
            z.position.add(dir.multiplyScalar(0.06));
            z.lookAt(0, 0.8, 0);

            const dist = z.position.distanceTo(new THREE.Vector3(0,0,0));
            if(dist < 2.7) {
                // Front Bumper Kill
                if(z.position.z < -1.8 && Math.abs(z.position.x) < 1.4) {
                    z.userData.active = false;
                    score++;
                    $("s-val").textContent = score;
                } else {
                    run = false;
                    $("game-over").classList.remove("hidden");
                }
            }
            z.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
        } else {
            z.scale.lerp(new THREE.Vector3(0,0,0), 0.2);
        }
    });

    renderer.render(scene, cam);
}
loop();
</script>
</body>
</html>
