<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Aim Pro: Zombie Survival</title>
    <style>
        :root { --n: #0fcc; --h: #f36; --p: #bf00ff; --death: #ff0000; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; color: #fff; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,.85); z-index: 20; backdrop-filter: blur(10px); text-align: center; }
        .hidden { display: none !important; }
        
        #hud { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .stat { background: rgba(0,0,0,.5); border-left: 4px solid var(--n); padding: 8px; margin-bottom: 5px; font-weight: bold; }
        #power-bar { width: 150px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        #power-fill { width: 0%; height: 100%; background: var(--p); transition: width 0.3s; box-shadow: 0 0 10px var(--p); }

        #diag-box { position: absolute; bottom: 15%; width: 80%; background: rgba(0,0,0,.9); border: 2px solid var(--n); padding: 20px; z-index: 50; border-radius: 10px; }
        
        #cross-cont { position: absolute; inset: 50%; width: 40px; height: 40px; transform: translate(-50%,-50%); pointer-events: none; z-index: 5; }
        #cross { width: 100%; height: 100%; border: 2px solid var(--n); border-radius: 50%; transition: .1s; }
        .hit #cross { border-color: var(--h); transform: scale(1.3); }
        
        #shoot { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--n); background: rgba(0,255,204,.1); color: var(--n); font-weight: bold; z-index: 30; display: flex; justify-content: center; align-items: center; }
        #slow-mo-btn { position: absolute; bottom: 40px; left: 40px; width: 70px; height: 70px; border-radius: 10px; border: 2px solid var(--p); color: var(--p); z-index: 30; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; font-weight: bold; }

        button { padding: 12px 30px; background: var(--n); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 5px; }
        #game-over-screen { background: rgba(50, 0, 0, 0.9); }
    </style>
</head>
<body>

<div id="hud" class="hidden">
    <div class="stat">WAVE: <span id="chap-n">1</span></div>
    <div class="stat">KILLS: <span id="s-val">0</span></div>
    <div id="power-bar"><div id="power-fill"></div></div>
</div>

<div id="cross-cont" class="hidden"><div id="cross"></div></div>
<div id="shoot" class="hidden">FIRE</div>
<div id="slow-mo-btn" class="hidden">SLOW<br>MO</div>

<div id="menu" class="screen">
    <h1 style="color:var(--n); text-shadow:0 0 15px var(--n)">ZOMBIE AIM PRO</h1>
    <div id="gun-sel">
        <button onclick="setGun(0)">PISTOL</button>
        <button onclick="setGun(1)">SNIPER</button>
        <button onclick="setGun(2)">SMG</button>
    </div>
    <button id="start-btn" style="background:#fff; color:#000; margin-top:20px;">START MISSION</button>
</div>

<div id="game-over-screen" class="screen hidden">
    <h1 style="color:var(--death); font-size: 3rem;">YOU WERE EATEN</h1>
    <p>FINAL SCORE: <span id="final-score">0</span></p>
    <button onclick="location.reload()">TRY AGAIN</button>
</div>

<div id="diag-box" class="hidden">
    <div id="diag-text"></div>
    <div style="font-size:0.8rem; color:var(--n); margin-top:10px;">[ TAP TO CONTINUE ]</div>
</div>

<script type="module">
import * as THREE from "https://cdn.skypack.dev/three@0.136.0";

const $ = id => document.getElementById(id);
const chapters = [
    { name: "The Streets", color: 0x00ffcc, diag: ["They're coming from the fog...", "Don't let them touch you.", "Aim for the heads!"] },
    { name: "The Breach", color: 0xff3366, diag: ["The horde is growing stronger.", "They are moving faster now!", "Watch your back."] }
];
const guns = [
    { name: "Pistol", rate: 400, pitch: 1 },
    { name: "Sniper", rate: 1200, pitch: 0.5 },
    { name: "SMG", rate: 150, pitch: 2 }
];

let curChap=0, curGun=0, score=0, run=false, power=0, isSlow=false, pool=[];
let lon=0, lat=0, sInt;

const ctx = new (window.AudioContext||window.webkitAudioContext)();
const tone = (f, t="sine", v=0.1, d=0.1) => {
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=t; o.frequency.value=f; g.gain.value=v;
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+d);
    o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+d);
};

// Three.js Setup
const scene = new THREE.Scene();
const cam = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.HemisphereLight(0x444444, 0x000000, 1);
scene.add(light);
const pL = new THREE.PointLight(0x00ffcc, 1, 10);
cam.add(pL);
scene.add(cam);

// Create Zombie Mesh (Group of Head and Body)
const createZombie = () => {
    const group = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.2, 0.4), new THREE.MeshPhongMaterial({color: 0x222222}));
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshPhongMaterial({color: 0x00ffcc}));
    head.position.y = 0.9;
    group.add(body, head);
    return group;
};

for(let i=0; i<20; i++) {
    const z = createZombie();
    z.visible = false; z.userData = { active: false };
    scene.add(z); pool.push(z);
}

const spawn = () => {
    if(!run) return;
    const z = pool.find(x => !x.userData.active);
    if(!z) return;
    
    // Spawn in a circle far away
    const angle = Math.random() * Math.PI * 2;
    const dist = 25;
    z.position.set(Math.cos(angle)*dist, -1, Math.sin(angle)*dist);
    
    // Randomize speed based on chapter
    z.userData.speed = (0.03 + (curChap * 0.02)) + (Math.random() * 0.02);
    z.userData.active = true;
    z.visible = true;
    z.children[1].material.color.set(chapters[curChap].color);
};

// Controls
let sx, sy, slon, slat;
window.addEventListener("touchstart", e => { sx=e.touches[0].clientX; sy=e.touches[0].clientY; slon=lon; slat=lat; });
window.addEventListener("touchmove", e => {
    if(!run) return;
    lon = slon - (e.touches[0].clientX - sx) * 0.2;
    lat = Math.max(-85, Math.min(85, slat + (sy - e.touches[0].clientY) * 0.2));
});

// Shooting
$("shoot").ontouchstart = e => {
    e.preventDefault(); if(!run) return;
    tone(80, "sawtooth", 0.1, 0.2);
    const ray = new THREE.Raycaster();
    ray.setFromCamera({x:0, y:0}, cam);
    const hits = ray.intersectObjects(pool, true);
    
    if(hits.length > 0) {
        let hitObj = hits[0].object;
        while(hitObj.parent && !hitObj.userData.active) hitObj = hitObj.parent;
        
        if(hitObj.userData.active) {
            hitObj.userData.active = false;
            score++; $("s-val").textContent = score;
            power = Math.min(100, power + 8);
            $("power-fill").style.width = power + "%";
            $("cross-cont").classList.add("hit"); 
            setTimeout(()=>$("cross-cont").classList.remove("hit"), 100);
            tone(400, "sine", 0.1, 0.05);
        }
    }
};

$("slow-mo-btn").ontouchstart = () => {
    if(power < 40 || isSlow) return;
    isSlow = true; power -= 40;
    $("power-fill").style.width = power + "%";
    tone(150, "sine", 0.2, 0.5);
    setTimeout(() => { isSlow = false; }, 3000);
};

window.setGun = (id) => { curGun = id; tone(400); };

const gameOver = () => {
    run = false;
    clearInterval(sInt);
    $("hud").classList.add("hidden");
    $("shoot").classList.add("hidden");
    $("cross-cont").classList.add("hidden");
    $("game-over-screen").classList.remove("hidden");
    $("final-score").textContent = score;
    tone(50, "sawtooth", 0.3, 1);
};

const showDialogue = (idx, cb) => {
    const lines = chapters[idx].diag;
    let i = 0;
    $("diag-box").classList.remove("hidden");
    $("diag-text").textContent = lines[i];
    const next = () => {
        i++;
        if(i < lines.length) $("diag-text").textContent = lines[i];
        else {
            $("diag-box").classList.add("hidden");
            window.removeEventListener("touchstart", next);
            cb();
        }
    };
    window.addEventListener("touchstart", next);
};

const startSequence = () => {
    $("menu").classList.add("hidden");
    showDialogue(curChap, () => {
        run = true;
        $("hud").classList.remove("hidden");
        $("shoot").classList.remove("hidden");
        $("cross-cont").classList.remove("hidden");
        $("slow-mo-btn").classList.remove("hidden");
        $("chap-n").textContent = curChap + 1;
        sInt = setInterval(spawn, 800 - (curChap * 200));
        setTimeout(() => {
            if(run && curChap < chapters.length -1) {
                curChap++; clearInterval(sInt); startSequence();
            }
        }, 20000);
    });
};

$("start-btn").onclick = () => { ctx.resume(); curChap=0; score=0; startSequence(); };

// Game Loop
(function loop(){
    requestAnimationFrame(loop);
    const timeMult = isSlow ? 0.2 : 1.0;
    
    cam.lookAt(new THREE.Vector3().setFromSphericalCoords(100, THREE.MathUtils.degToRad(90-lat), THREE.MathUtils.degToRad(lon)));
    
    pool.forEach(z => {
        if(z.userData.active) {
            // Move toward player (0,0,0)
            const dir = new THREE.Vector3(0, -1, 0).sub(z.position).normalize();
            z.position.add(dir.multiplyScalar(z.userData.speed * timeMult));
            z.lookAt(0, -1, 0);

            // Check distance for Death
            const dist = z.position.distanceTo(new THREE.Vector3(0,0,0));
            if(dist < 2.5) gameOver();

            z.scale.lerp(new THREE.Vector3(1,1,1), 0.1);
        } else {
            z.scale.lerp(new THREE.Vector3(0,0,0), 0.2);
            if(z.scale.x < 0.05) z.visible = false;
        }
    });
    renderer.render(scene, cam);
})();
</script>
</body>
</html>
