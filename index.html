<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D FPS Aim Trainer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        
        #ui { position: absolute; top: 20px; left: 20px; color: #00ffcc; font-size: 20px; pointer-events: none; z-index: 10; }
        .stat { margin-bottom: 5px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; display: inline-block; }

        #crosshair { 
            position: absolute; top: 50%; left: 50%; 
            width: 16px; height: 16px; border: 2px solid #00ffcc; border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 5;
        }

        #shoot-btn {
            position: absolute; bottom: 50px; right: 50px;
            width: 90px; height: 90px; background: rgba(0, 255, 204, 0.1);
            border: 3px solid #00ffcc; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #00ffcc; font-weight: bold; z-index: 30;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.95); color: white; z-index: 40; text-align: center;
        }
        #countdown { font-size: 80px; color: #00ffcc; margin: 20px 0; }
        button { padding: 15px 40px; font-size: 22px; background: #00ffcc; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat">SCORE: <span id="score">0</span></div><br>
        <div class="stat">TIME: <span id="timer">60</span>s</div>
    </div>
    
    <div id="crosshair"></div>
    <div id="shoot-btn">FIRE</div>
    
    <div id="overlay">
        <h1 id="msg">FPS AIM TRAINER</h1>
        <p id="sub-msg">Swipe to AIM | Button to FIRE</p>
        <button id="start-btn">START SESSION</button>
        <div id="countdown"></div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let gameInterval, timerInterval;
        const targets = [];
        
        // Touch state
        let lon = 0, lat = 0;
        let phi = 0, theta = 0;
        let startX, startY, startLon, startLat;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(freq, type, duration, vol=0.05) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.GridHelper(100, 40, 0x00ffcc, 0x112222));
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));

        const overlay = document.getElementById('overlay');
        const startBtn = document.getElementById('start-btn');

        startBtn.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resetGame();
            startBtn.style.display = 'none';
            document.getElementById('msg').style.display = 'none';
            document.getElementById('sub-msg').style.display = 'none';
            startCountdown();
        });

        function resetGame() {
            score = 0;
            timeLeft = 60;
            document.getElementById('score').innerText = "0";
            document.getElementById('timer').innerText = "60";
            targets.forEach(t => scene.remove(t));
            targets.length = 0;
        }

        function startCountdown() {
            let count = 3;
            const cd = document.getElementById('countdown');
            cd.innerText = count;
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    cd.innerText = count;
                    playSound(440, 'sine', 0.1);
                } else {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    cd.innerText = "";
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            gameActive = true;
            spawnTarget();
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            overlay.style.display = 'flex';
            document.getElementById('msg').innerText = "SESSION COMPLETE";
            document.getElementById('msg').style.display = 'block';
            document.getElementById('sub-msg').innerText = "FINAL SCORE: " + score;
            document.getElementById('sub-msg').style.display = 'block';
            startBtn.style.display = 'block';
            startBtn.innerText = "TRY AGAIN";
        }

        function spawnTarget() {
            if (!gameActive) return;
            const geo = new THREE.SphereGeometry(0.8, 16, 16);
            const mat = new THREE.MeshPhongMaterial({ color: 0xff0055, emissive: 0x330000 });
            const target = new THREE.Mesh(geo, mat);
            
            const angle = (Math.random() - 0.5) * Math.PI * 1.2;
            const dist = 15 + Math.random() * 5;
            target.position.set(Math.sin(angle) * dist, (Math.random() - 0.5) * 8 + 2, -Math.cos(angle) * dist);
            
            scene.add(target);
            targets.push(target);
            
            setTimeout(() => {
                scene.remove(target);
                const idx = targets.indexOf(target);
                if (idx > -1) targets.splice(idx, 1);
            }, 2000);

            setTimeout(spawnTarget, 800);
        }

        // --- NORMAL TOUCH CONTROLS ---
        document.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            startLon = lon;
            startLat = lat;
        });

        document.addEventListener('touchmove', (e) => {
            if (!gameActive) return;
            const dx = e.touches[0].clientX - startX; // Move finger Right -> DX is positive
            const dy = startY - e.touches[0].clientY; // Move finger Up -> DY is positive
            
            // Sensitivity: 0.15. Adjust this to make it faster/slower.
            lon = startLon - dx * 0.15; // Decreasing Lon turns the camera Right
            lat = startLat + dy * 0.15; // Increasing Lat looks Up
            
            lat = Math.max(-85, Math.min(85, lat));
        });

        document.getElementById('shoot-btn').addEventListener('touchstart', (e) => {
            e.stopPropagation();
            if (!gameActive) return;

            playSound(120, 'sawtooth', 0.1, 0.1); 

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera({ x: 0, y: 0 }, camera);
            const intersects = raycaster.intersectObjects(targets);
            
            if (intersects.length > 0) {
                const hit = intersects[0].object;
                scene.remove(hit);
                targets.splice(targets.indexOf(hit), 1);
                score++;
                document.getElementById('score').innerText = score;
                playSound(1200, 'sine', 0.05, 0.2);
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            phi = THREE.MathUtils.degToRad(90 - lat);
            theta = THREE.MathUtils.degToRad(lon);

            const targetPos = new THREE.Vector3();
            targetPos.setFromSphericalCoords(100, phi, theta);
            camera.lookAt(targetPos);
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
